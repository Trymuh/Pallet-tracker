<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PalletTracker Pro | Enterprise</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #ea580c; --danger: #e11d48; --dark: #0b0f19; --light: #f8fafc; --border: #e2e8f0; }
        body { margin: 0; font-family: 'Outfit', sans-serif; background: var(--light); height: 100vh; overflow: hidden; }
        
        /* Auth */
        #authGate { display: flex; align-items: center; justify-content: center; height: 100vh; background: var(--dark); z-index: 10000; position: relative; }
        .login-box { background: white; padding: 40px; border-radius: 20px; width: 340px; text-align: center; }
        .login-box input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; }
        
        /* Layout */
        #appShell { display: none; height: 100vh; flex-direction: row; }
        .sidebar { width: 260px; background: var(--dark); color: white; padding: 25px; display: flex; flex-direction: column; }
        .nav-item { padding: 12px; color: #94a3b8; cursor: pointer; border-radius: 8px; margin-bottom: 5px; font-weight: 600; }
        .nav-item.active { background: var(--primary); color: white; }
        
        .main { flex: 1; padding: 40px; overflow-y: auto; }
        .hidden { display: none !important; }

        /* Dashboard Components */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
        .stat-card.alert { border: 2px solid var(--danger); background: #fff1f2; }
        .stat-card h4 { margin: 0; font-size: 0.75rem; color: #64748b; text-transform: uppercase; }
        .stat-card p { margin: 5px 0 0 0; font-size: 1.6rem; font-weight: 700; }

        .chart-container { background: white; padding: 20px; border-radius: 16px; border: 1px solid var(--border); height: 300px; margin-bottom: 30px; }
        
        /* Tables */
        .data-table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; border: 1px solid var(--border); }
        .data-table th { background: #f1f5f9; padding: 12px; text-align: left; font-size: 0.8rem; color: #64748b; }
        .data-table td { padding: 12px; border-top: 1px solid var(--border); font-size: 0.9rem; }

        .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-family: inherit; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: #fee2e2; color: var(--danger); font-size: 0.75rem; }
        .btn-outline { border: 1px solid var(--border); background: white; font-size: 0.75rem; }

        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index: 9999; }
        .modal-content { background:white; padding:30px; border-radius:16px; width:400px; }
    </style>
</head>
<body>

    <div id="authGate">
        <div class="login-box">
            <h2>PalletTracker Pro</h2>
            <div id="authError" style="color:red; font-size:0.8rem; margin-bottom:10px; display:none;"></div>
            <input type="email" id="emailField" placeholder="Email">
            <input type="password" id="passField" placeholder="Password">
            <button class="btn btn-primary" style="width:100%; margin-top:10px" onclick="handleLogin()">Login</button>
        </div>
    </div>

    <div id="appShell">
        <div class="sidebar">
            <h3 style="margin-bottom:30px">ðŸ“¦ Warehouse Admin</h3>
            <div class="nav-item active" onclick="switchView('dash', this)">Dashboard</div>
            <div class="nav-item" onclick="switchView('cust', this)">Customers</div>
            <div class="nav-item" onclick="switchView('logs', this)">Transaction History</div>
            
            <div style="margin-top:auto; padding:15px; background:#1e293b; border-radius:12px; font-size:0.8rem;">
                <label>Set Warehouse Stock</label>
                <input type="number" id="baseStock" value="200" style="width:100%; background:none; border:1px solid #334155; color:white; padding:5px; margin-top:5px;" onchange="refreshData()">
            </div>
            <button class="btn btn-outline" style="margin-top:15px; color:white; border-color:#334155;" onclick="handleLogout()">Sign Out</button>
        </div>

        <div class="main" id="view-dash">
            <h1>Warehouse Overview</h1>
            <div class="stats-grid">
                <div class="stat-card" id="stockCard">
                    <h4>Warehouse Stock</h4>
                    <p id="stat-stock">0</p>
                    <small id="stockWarning" style="color:var(--danger); display:none; font-weight:bold;">LOW STOCK ALERT!</small>
                </div>
                <div class="stat-card"><h4>Market Debt</h4><p id="stat-debt" style="color:var(--danger)">0</p></div>
                <div class="stat-card"><h4>Active Clients</h4><p id="stat-cust">0</p></div>
                <div class="stat-card"><h4>Monthly Out</h4><p id="stat-flow">0</p></div>
            </div>
            <div class="chart-container"><canvas id="debtChart"></canvas></div>
            <h3>Quick Actions</h3>
            <table class="data-table">
                <thead><tr><th>Customer</th><th>Balance</th><th style="text-align:right">Action</th></tr></thead>
                <tbody id="dashBody"></tbody>
            </table>
        </div>

        <div class="main hidden" id="view-cust">
            <h1>Customer Database</h1>
            <div class="stat-card" style="margin-bottom:20px">
                <h4>Register New Client</h4>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <input type="text" id="newCustName" placeholder="Company Name" style="flex:1; padding:10px; border:1px solid var(--border); border-radius:8px;">
                    <button class="btn btn-primary" onclick="addCustomer()">Add Company</button>
                </div>
            </div>
            <table class="data-table">
                <thead><tr><th>Name</th><th>Sent</th><th>Returned</th><th>Balance</th><th style="text-align:right">Statement</th></tr></thead>
                <tbody id="manageBody"></tbody>
            </table>
        </div>

        <div class="main hidden" id="view-logs">
            <h1>Audit Trail</h1>
            <div style="margin-bottom:20px;">
                <input type="text" id="logSearch" placeholder="Search by customer name..." style="padding:12px; width:300px; border-radius:8px; border:1px solid var(--border);" onkeyup="filterLogs()">
            </div>
            <table class="data-table">
                <thead><tr><th>Date</th><th>Customer</th><th>Type</th><th>Qty</th><th>Action</th></tr></thead>
                <tbody id="logsBody"></tbody>
            </table>
        </div>
    </div>

    <div id="logModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">Log Flow</h3>
            <input type="text" id="mCust" readonly style="background:#f1f5f9; border:none; padding:10px; width:100%; margin-bottom:15px; border-radius:8px; font-weight:bold;">
            <select id="mType" style="width:100%; padding:10px; margin-bottom:15px; border-radius:8px;"><option value="Consumed">Send Out (Consumed)</option><option value="Received">Receive (Returned)</option></select>
            <input type="number" id="mQty" placeholder="Quantity" style="width:100%; padding:10px; margin-bottom:20px; border-radius:8px;">
            <div style="display:flex; gap:10px;">
                <button class="btn" onclick="closeModal()" style="flex:1; background:#eee">Cancel</button>
                <button class="btn btn-primary" onclick="submitLog()" style="flex:2">Save Entry</button>
            </div>
        </div>
    </div>

    <script>
    (function() {
        const _U = 'https://yeiisilddmpgphvcuqxf.supabase.co';
        const _K = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InllaWlzaWxkZG1wZ3BodmN1cXhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0ODM4MjksImV4cCI6MjA4NzA1OTgyOX0.0f2xE3NqZm9QrWAlSi-AoLMWT4cqiArbY6VMt0KlHDA';
        const client = window.supabase.createClient(_U, _K);
        let myChart = null;

        window.handleLogin = async () => {
            const { error } = await client.auth.signInWithPassword({ email: document.getElementById('emailField').value, password: document.getElementById('passField').value });
            if (error) { document.getElementById('authError').innerText = error.message; document.getElementById('authError').style.display = 'block'; }
        };
        window.handleLogout = async () => { await client.auth.signOut(); };

        client.auth.onAuthStateChange((evt, session) => {
            document.getElementById('authGate').style.display = session ? 'none' : 'flex';
            document.getElementById('appShell').style.display = session ? 'flex' : 'none';
            if (session) refreshData();
        });

        window.switchView = (v, el) => {
            document.querySelectorAll('.main').forEach(m => m.classList.add('hidden'));
            document.getElementById('view-' + v).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            refreshData();
        };

        window.refreshData = async () => {
            const { data: custs } = await client.from('customers').select('*').order('name');
            const { data: logs } = await client.from('transactions').select('*').order('date', {ascending: false});
            
            const baseStock = parseInt(document.getElementById('baseStock').value) || 0;
            let debt = 0, flow = 0, totalReturned = 0, labels = [], vals = [];
            
            // Build Dashboard & Customer Tables
            const dBody = document.getElementById('dashBody'); dBody.innerHTML = '';
            const mBody = document.getElementById('manageBody'); mBody.innerHTML = '';
            
            custs.forEach(c => {
                const b = (c.delivered || 0) - (c.returned || 0);
                debt += b; flow += (c.delivered || 0); totalReturned += (c.returned || 0);
                labels.push(c.name); vals.push(b);
                
                dBody.innerHTML += `<tr><td><strong>${c.name}</strong></td><td>${b}</td><td style="text-align:right"><button class="btn btn-primary" style="padding:4px 10px; font-size:11px;" onclick="openModal('${c.name}')">Log</button></td></tr>`;
                mBody.innerHTML += `<tr><td>${c.name}</td><td>${c.delivered}</td><td>${c.returned}</td><td><strong>${b}</strong></td><td style="text-align:right"><button class="btn btn-outline" onclick="generatePDF('${c.name}')">PDF</button></td></tr>`;
            });

            // Warehouse Stock Logic
            const currentWarehouseStock = baseStock + totalReturned - flow;
            const stockDisplay = document.getElementById('stat-stock');
            stockDisplay.innerText = currentWarehouseStock;
            const stockCard = document.getElementById('stockCard');
            const warning = document.getElementById('stockWarning');
            
            if (currentWarehouseStock < 50) {
                stockCard.classList.add('alert');
                warning.style.display = 'block';
            } else {
                stockCard.classList.remove('alert');
                warning.style.display = 'none';
            }

            document.getElementById('stat-debt').innerText = debt;
            document.getElementById('stat-cust').innerText = custs.length;
            document.getElementById('stat-flow').innerText = flow;

            // Build Transaction Logs
            const lBody = document.getElementById('logsBody'); lBody.innerHTML = '';
            logs.forEach(l => {
                lBody.innerHTML += `<tr data-name="${l.customer.toLowerCase()}">
                    <td>${l.date}</td><td>${l.customer}</td>
                    <td><span style="color:${l.type === 'Consumed' ? '#ea580c' : '#16a34a'}">${l.type}</span></td>
                    <td>${l.qty}</td>
                    <td><button class="btn btn-danger" onclick="deleteLog(${l.id}, '${l.customer}', '${l.type}', ${l.qty})">Del</button></td>
                </tr>`;
            });

            if (typeof Chart !== 'undefined' && labels.length > 0) updateChart(labels, vals);
        };

        window.deleteLog = async (id, name, type, qty) => {
            if(!confirm("Delete this transaction? Balance will be corrected.")) return;
            await client.from('transactions').delete().eq('id', id);
            const { data: c } = await client.from('customers').select('*').eq('name', name).single();
            const up = type === 'Consumed' ? { delivered: c.delivered - qty } : { returned: c.returned - qty };
            await client.from('customers').update(up).eq('name', name);
            refreshData();
        };

        window.generatePDF = async (name) => {
            const { data: logs } = await client.from('transactions').select('*').eq('customer', name).order('date');
            const { data: c } = await client.from('customers').select('*').eq('name', name).single();
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFont("helvetica", "bold");
            doc.text(`Pallet Statement: ${name}`, 14, 20);
            doc.setFontSize(10);
            doc.text(`Current Outstanding Balance: ${(c.delivered - c.returned)} Pallets`, 14, 28);
            
            const tableData = logs.map(l => [l.date, l.type, l.qty]);
            doc.autoTable({ head: [['Date', 'Transaction Type', 'Quantity']], body: tableData, startY: 35 });
            doc.save(`${name}_Pallet_Report.pdf`);
        };

        window.filterLogs = () => {
            const val = document.getElementById('logSearch').value.toLowerCase();
            document.querySelectorAll('#logsBody tr').forEach(tr => {
                tr.style.display = tr.dataset.name.includes(val) ? '' : 'none';
            });
        };

        // Standard helpers
        function updateChart(l, d) {
            const ctx = document.getElementById('debtChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, { type: 'bar', data: { labels: l, datasets: [{ label: 'Owed', data: d, backgroundColor: '#ea580c', borderRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
        }
        window.openModal = (n) => { document.getElementById('mCust').value = n; document.getElementById('logModal').style.display = 'flex'; };
        window.closeModal = () => { document.getElementById('logModal').style.display = 'none'; };
        window.addCustomer = async () => {
            const name = document.getElementById('newCustName').value.trim();
            if(!name) return;
            await client.from('customers').insert([{ name, delivered: 0, returned: 0 }]);
            document.getElementById('newCustName').value = '';
            refreshData();
        };
        window.submitLog = async () => {
            const name = document.getElementById('mCust').value;
            const type = document.getElementById('mType').value;
            const qty = parseInt(document.getElementById('mQty').value);
            if(!qty) return;
            await client.from('transactions').insert([{ customer: name, type, qty, date: new Date().toISOString().split('T')[0] }]);
            const { data: c } = await client.from('customers').select('*').eq('name', name).single();
            const up = type === 'Consumed' ? { delivered: (c.delivered || 0) + qty } : { returned: (c.returned || 0) + qty };
            await client.from('customers').update(up).eq('name', name);
            closeModal(); refreshData();
        };
    })();
    </script>
</body>
</html>