<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PalletTracker Pro</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #ea580c; --dark: #0b0f19; --light: #f8fafc; --border: #e2e8f0; }
        body { margin: 0; font-family: 'Outfit', sans-serif; background: var(--light); height: 100vh; overflow: hidden; }
        #authGate { display: flex; align-items: center; justify-content: center; height: 100vh; background: var(--dark); }
        .login-box { background: white; padding: 40px; border-radius: 20px; width: 340px; text-align: center; }
        .login-box input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; }
        #appShell { display: none; height: 100vh; flex-direction: row; }
        .sidebar { width: 260px; background: var(--dark); color: white; padding: 25px; }
        .main { flex: 1; padding: 40px; overflow-y: auto; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
        .stat-card p { margin: 5px 0 0 0; font-size: 1.8rem; font-weight: 700; }
        .chart-container { background: white; padding: 20px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 30px; height: 350px; position: relative; }
        .data-table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; border: 1px solid var(--border); }
        .data-table th { background: #f1f5f9; padding: 15px; text-align: left; }
        .data-table td { padding: 15px; border-top: 1px solid var(--border); }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-family: inherit; }
        .btn-primary { background: var(--primary); color: white; }
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index: 9999; }
        .modal-content { background:white; padding:30px; border-radius:16px; width:380px; }
    </style>
</head>
<body>

    <div id="authGate">
        <div class="login-box">
            <h2>PalletTracker Pro</h2>
            <div id="authError" style="color:red; font-size:0.8rem; margin-bottom:10px; display:none;"></div>
            <input type="email" id="emailField" placeholder="Email">
            <input type="password" id="passField" placeholder="Password">
            <button class="btn btn-primary" style="width:100%; margin-top:10px" onclick="handleLogin()">Login</button>
        </div>
    </div>

    <div id="appShell">
        <div class="sidebar">
            <h3 style="margin:0">ðŸ“¦ Warehouse</h3>
            <p style="margin-top:40px; color:#94a3b8">Dashboard</p>
            <button class="btn" style="margin-top:auto; width:100%; background:#1e293b; color:white;" onclick="handleLogout()">Sign Out</button>
        </div>
        <div class="main">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h1 style="margin:0">Warehouse Metrics</h1>
                <button class="btn" style="background:#ddd" onclick="refreshDashboard()">Refresh Graph</button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card"><h4>Active Debt</h4><p id="stat-debt" style="color:#e11d48">0</p></div>
                <div class="stat-card"><h4>Total Customers</h4><p id="stat-cust">0</p></div>
                <div class="stat-card"><h4>Total Consumed</h4><p id="stat-flow">0</p></div>
            </div>

            <div class="chart-container">
                <canvas id="debtChart"></canvas>
            </div>

            <h3>Customer Breakdown</h3>
            <table class="data-table">
                <thead><tr><th>Customer</th><th>Consumed</th><th>Returned</th><th>Balance</th><th style="text-align:right">Action</th></tr></thead>
                <tbody id="customerBody"></tbody>
            </table>
        </div>
    </div>

    <div id="logModal" class="modal">
        <div class="modal-content">
            <h3>Log Transaction</h3>
            <input type="text" id="mCust" readonly style="background:#f1f5f9; border:none; font-weight:bold;">
            <select id="mType"><option value="Consumed">Consumed (Outgoing)</option><option value="Received">Received (Incoming)</option></select>
            <input type="number" id="mQty" placeholder="Quantity">
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn" onclick="closeModal()" style="flex:1; background:#eee">Cancel</button>
                <button class="btn btn-primary" onclick="submitLog()" style="flex:2">Confirm</button>
            </div>
        </div>
    </div>

    <script>
    (function() {
        const _U = 'https://yeiisilddmpgphvcuqxf.supabase.co';
        const _K = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InllaWlzaWxkZG1wZ3BodmN1cXhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0ODM4MjksImV4cCI6MjA4NzA1OTgyOX0.0f2xE3NqZm9QrWAlSi-AoLMWT4cqiArbY6VMt0KlHDA';
        const client = window.supabase.createClient(_U, _K);
        let myChart = null;

        window.handleLogin = async () => {
            const { error } = await client.auth.signInWithPassword({
                email: document.getElementById('emailField').value,
                password: document.getElementById('passField').value
            });
            if (error) { document.getElementById('authError').innerText = error.message; document.getElementById('authError').style.display = 'block'; }
        };

        window.handleLogout = async () => { await client.auth.signOut(); };

        client.auth.onAuthStateChange((event, session) => {
            document.getElementById('authGate').style.display = session ? 'none' : 'flex';
            document.getElementById('appShell').style.display = session ? 'flex' : 'none';
            if (session) setTimeout(refreshDashboard, 500); // Wait 0.5s for DOM to settle
        });

        window.refreshDashboard = async () => {
            const { data: custs } = await client.from('customers').select('*').order('name');
            let debt = 0, flow = 0, labels = [], vals = [];
            const body = document.getElementById('customerBody'); 
            body.innerHTML = '';

            custs.forEach(c => {
                const b = c.delivered - c.returned;
                debt += b; flow += c.delivered;
                labels.push(c.name); 
                vals.push(b);
                body.innerHTML += `<tr>
                    <td><strong>${c.name}</strong></td>
                    <td>${c.delivered}</td><td>${c.returned}</td>
                    <td style="color:${b > 0 ? '#e11d48' : '#16a34a'}; font-weight:700">${b}</td>
                    <td style="text-align:right"><button class="btn" style="background:#f1f5f9; font-size:12px;" onclick="openModal('${c.name}')">Log Flow</button></td>
                </tr>`;
            });

            document.getElementById('stat-debt').innerText = debt;
            document.getElementById('stat-cust').innerText = custs.length;
            document.getElementById('stat-flow').innerText = flow;
            
            // Critical: Check if Chart is available
            if (typeof Chart !== 'undefined') {
                updateTheChart(labels, vals);
            } else {
                console.error("Chart.js failed to load.");
                document.querySelector('.chart-container').innerText = "Graph loading error. Please check internet connection.";
            }
        };

        function updateTheChart(l, d) {
            const ctx = document.getElementById('debtChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: l,
                    datasets: [{
                        label: 'Pallets Owed',
                        data: d,
                        backgroundColor: '#ea580c',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        window.openModal = (n) => { document.getElementById('mCust').value = n; document.getElementById('logModal').style.display = 'flex'; };
        window.closeModal = () => { document.getElementById('logModal').style.display = 'none'; };

        window.submitLog = async () => {
            const name = document.getElementById('mCust').value;
            const type = document.getElementById('mType').value;
            const qty = parseInt(document.getElementById('mQty').value);
            if(!qty) return;

            await client.from('transactions').insert([{ customer: name, type, qty, date: new Date().toISOString().split('T')[0] }]);
            const { data: c } = await client.from('customers').select('*').eq('name', name).single();
            const up = type === 'Consumed' ? { delivered: c.delivered + qty } : { returned: c.returned + qty };
            await client.from('customers').update(up).eq('name', name);
            closeModal(); refreshDashboard();
        };
    })();
    </script>
</body>
</html>