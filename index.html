<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PalletTracker Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #ea580c; --dark: #0b0f19; --light: #f8fafc; --border: #e2e8f0; }
        body { margin: 0; font-family: 'Outfit', sans-serif; background: var(--light); height: 100vh; overflow: hidden; }
        #authGate { display: flex; align-items: center; justify-content: center; height: 100vh; background: var(--dark); }
        .login-box { background: white; padding: 40px; border-radius: 20px; width: 340px; text-align: center; }
        .login-box input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; }
        #appShell { display: none; height: 100vh; flex-direction: row; }
        .sidebar { width: 260px; background: var(--dark); color: white; padding: 25px; display: flex; flex-direction: column; }
        .nav-item { padding: 12px; color: #94a3b8; cursor: pointer; border-radius: 8px; margin-bottom: 5px; transition: 0.2s; font-weight: 600; }
        .nav-item:hover { background: #1e293b; color: white; }
        .nav-item.active { background: var(--primary); color: white; }
        .main { flex: 1; padding: 40px; overflow-y: auto; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border); position: relative; }
        .stat-card h4 { margin: 0; font-size: 0.8rem; color: #64748b; text-transform: uppercase; }
        .stat-card p { margin: 5px 0 0 0; font-size: 1.8rem; font-weight: 700; }
        .chart-container { background: white; padding: 20px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 30px; height: 350px; }
        .data-table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; border: 1px solid var(--border); margin-top: 10px; }
        .data-table th { background: #f1f5f9; padding: 15px; text-align: left; font-size: 0.8rem; }
        .data-table td { padding: 15px; border-top: 1px solid var(--border); }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-family: inherit; }
        .btn-primary { background: var(--primary); color: white; }
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index: 9999; }
        .modal-content { background:white; padding:30px; border-radius:16px; width:380px; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="authGate">
        <div class="login-box">
            <h2>PalletTracker Pro</h2>
            <div id="authError" style="color:red; font-size:0.8rem; margin-bottom:10px; display:none;"></div>
            <input type="email" id="emailField" placeholder="Email">
            <input type="password" id="passField" placeholder="Password">
            <button class="btn btn-primary" style="width:100%; margin-top:10px" onclick="handleLogin()">Login</button>
        </div>
    </div>

    <div id="appShell">
        <div class="sidebar">
            <h3 style="margin:0 0 30px 0">ðŸ“¦ Warehouse</h3>
            <div class="nav-item active" id="nav-dash" onclick="switchView('dash')">Dashboard</div>
            <div class="nav-item" id="nav-cust" onclick="switchView('cust')">Customer Management</div>
            <button class="btn" style="margin-top:auto; background:#1e293b; color:white;" onclick="handleLogout()">Sign Out</button>
        </div>
        
        <div class="main" id="view-dash">
            <h1>Dashboard</h1>
            <div class="stats-grid">
                <div class="stat-card"><h4>Active Debt</h4><p id="stat-debt" style="color:#e11d48">0</p></div>
                <div class="stat-card"><h4>Total Customers</h4><p id="stat-cust">0</p></div>
                <div class="stat-card"><h4>Pallet Throughput</h4><p id="stat-flow">0</p></div>
            </div>
            <div class="chart-container"><canvas id="debtChart"></canvas></div>
            <h3>Recent Balances</h3>
            <table class="data-table">
                <thead><tr><th>Customer Name</th><th>Current Balance</th><th style="text-align:right">Action</th></tr></thead>
                <tbody id="dashBody"></tbody>
            </table>
        </div>

        <div class="main hidden" id="view-cust">
            <h1>Customer Management</h1>
            <div class="stat-card" style="margin-bottom: 25px;">
                <h4>Register New Customer</h4>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <input type="text" id="newCustName" placeholder="Enter Company Name" style="flex:1; padding:10px; border:1px solid var(--border); border-radius:8px;">
                    <button class="btn btn-primary" onclick="addCustomer()">Add to Database</button>
                </div>
            </div>
            <table class="data-table">
                <thead><tr><th>Name</th><th>Total Consumed</th><th>Total Returned</th><th>Live Balance</th></tr></thead>
                <tbody id="manageBody"></tbody>
            </table>
        </div>
    </div>

    <div id="logModal" class="modal">
        <div class="modal-content">
            <h3>Log Pallet Movement</h3>
            <input type="text" id="mCust" readonly style="background:#f1f5f9; border:none; font-weight:bold; margin-bottom:10px; width:100%; padding:10px; border-radius:8px;">
            <label style="font-size: 0.75rem; color: #64748b;">Type of Transaction</label>
            <select id="mType" style="width:100%; padding:10px; margin-bottom:15px; border-radius:8px;"><option value="Consumed">Consumed (Sending Out)</option><option value="Received">Received (Back to Warehouse)</option></select>
            <label style="font-size: 0.75rem; color: #64748b;">Quantity</label>
            <input type="number" id="mQty" placeholder="Amount" style="width:100%; padding:10px; margin-bottom:15px; border-radius:8px;">
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn" onclick="closeModal()" style="flex:1; background:#eee">Cancel</button>
                <button class="btn btn-primary" onclick="submitLog()" style="flex:2">Save Entry</button>
            </div>
        </div>
    </div>

    <script>
    (function() {
        const _U = 'https://yeiisilddmpgphvcuqxf.supabase.co';
        const _K = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InllaWlzaWxkZG1wZ3BodmN1cXhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0ODM4MjksImV4cCI6MjA4NzA1OTgyOX0.0f2xE3NqZm9QrWAlSi-AoLMWT4cqiArbY6VMt0KlHDA';
        const client = window.supabase.createClient(_U, _K);
        let myChart = null;

        window.handleLogin = async () => {
            const { error } = await client.auth.signInWithPassword({ email: document.getElementById('emailField').value, password: document.getElementById('passField').value });
            if (error) { document.getElementById('authError').innerText = error.message; document.getElementById('authError').style.display = 'block'; }
        };
        window.handleLogout = async () => { await client.auth.signOut(); };

        client.auth.onAuthStateChange((event, session) => {
            document.getElementById('authGate').style.display = session ? 'none' : 'flex';
            document.getElementById('appShell').style.display = session ? 'flex' : 'none';
            if (session) refreshData();
        });

        window.switchView = (v) => {
            document.getElementById('view-dash').classList.toggle('hidden', v !== 'dash');
            document.getElementById('view-cust').classList.toggle('hidden', v !== 'cust');
            document.getElementById('nav-dash').classList.toggle('active', v === 'dash');
            document.getElementById('nav-cust').classList.toggle('active', v === 'cust');
            if(v === 'dash') refreshData();
            if(v === 'cust') refreshData();
        };

        window.refreshData = async () => {
            const { data: custs } = await client.from('customers').select('*').order('name');
            let debt = 0, flow = 0, labels = [], vals = [];
            const dBody = document.getElementById('dashBody');
            const mBody = document.getElementById('manageBody');
            dBody.innerHTML = ''; mBody.innerHTML = '';

            custs.forEach(c => {
                const b = (c.delivered || 0) - (c.returned || 0);
                debt += b; flow += (c.delivered || 0);
                labels.push(c.name); vals.push(b);
                
                dBody.innerHTML += `<tr><td><strong>${c.name}</strong></td><td>${b}</td><td style="text-align:right"><button class="btn btn-primary" style="padding:5px 12px; font-size:12px;" onclick="openModal('${c.name}')">Log Flow</button></td></tr>`;
                mBody.innerHTML += `<tr><td><strong>${c.name}</strong></td><td>${c.delivered || 0}</td><td>${c.returned || 0}</td><td><strong>${b}</strong></td></tr>`;
            });

            document.getElementById('stat-debt').innerText = debt;
            document.getElementById('stat-cust').innerText = custs.length;
            document.getElementById('stat-flow').innerText = flow;
            if (typeof Chart !== 'undefined' && labels.length > 0) updateChart(labels, vals);
        };

        function updateChart(l, d) {
            const ctx = document.getElementById('debtChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: l, datasets: [{ label: 'Pallets Owed', data: d, backgroundColor: '#ea580c', borderRadius: 6 }] },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        window.addCustomer = async () => {
            const name = document.getElementById('newCustName').value.trim();
            if(!name) return alert("Please enter a company name");
            const { error } = await client.from('customers').insert([{ name, delivered: 0, returned: 0 }]);
            if (error) return alert("Error adding customer: " + error.message);
            document.getElementById('newCustName').value = '';
            refreshData();
        };

        window.openModal = (n) => { document.getElementById('mCust').value = n; document.getElementById('logModal').style.display = 'flex'; };
        window.closeModal = () => { document.getElementById('logModal').style.display = 'none'; };
        
        window.submitLog = async () => {
            const name = document.getElementById('mCust').value;
            const type = document.getElementById('mType').value;
            const qty = parseInt(document.getElementById('mQty').value);
            if(!qty) return alert("Please enter a quantity");

            await client.from('transactions').insert([{ customer: name, type, qty, date: new Date().toISOString().split('T')[0] }]);
            const { data: c } = await client.from('customers').select('*').eq('name', name).single();
            const up = type === 'Consumed' ? { delivered: (c.delivered || 0) + qty } : { returned: (c.returned || 0) + qty };
            await client.from('customers').update(up).eq('name', name);
            closeModal(); 
            refreshData();
        };
    })();
    </script>
</body>
</html>